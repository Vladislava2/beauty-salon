<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout}">
<div th:fragment="content">

  <!-- Центрирана карта като при login -->
  <div style="min-height:calc(100vh - 120px); display:flex; align-items:center; justify-content:center; padding:32px;">
    <div class="card" style="width:min(880px, 96vw); padding:34px;">
      <h2 class="h2" style="text-align:center; margin-bottom:4px;">Запазване на час</h2>
      <p class="small" style="text-align:center; margin-bottom:18px;">Попълни детайлите и избери удобен час</p>

      <!-- по желание: лента/снимка в горната част -->
      <div style="overflow:hidden; border-radius:14px; margin-bottom:18px;">
        <img th:src="@{/img/booking-hero.jpg}" alt="Beauty Salon" style="width:100%; max-height:220px; object-fit:cover;">
      </div>

      <!-- известия -->
      <div class="alert alert-success" th:if="${ok}">
        Успешно запазихме часа ви. Ще получите потвърждение по email.
      </div>
      <div class="alert alert-danger" th:if="${error}" th:text="${error}"></div>

      <!-- форма -->
      <form method="post" th:action="@{/booking}" th:object="${appointment}" style="margin-top:8px;">
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:16px;">
          <div>
            <label class="small">Име</label>
            <input class="input" th:field="*{customerName}" required>
            <div class="text-danger small" th:errors="*{customerName}"></div>
          </div>

          <div>
            <label class="small">Имейл</label>
            <input class="input" th:field="*{customerEmail}">
            <div class="text-danger small" th:errors="*{customerEmail}"></div>
          </div>

          <div>
            <label class="small">Телефон</label>
            <input class="input" th:field="*{customerPhone}">
            <div class="text-danger small" th:errors="*{customerPhone}"></div>
          </div>

          <div>
            <label class="small">Услуга</label>
            <select class="select" th:field="*{service.id}">
              <option th:each="s : ${services}" th:value="${s.id}" th:text="${s.name}"></option>
            </select>
          </div>

          <div>
            <label class="small">Дата</label>
            <input type="date" id="date" class="input">
          </div>

          <div>
            <label class="small">Свободни часове</label>
            <select id="slots" class="select"></select>
          </div>

          <div>
            <label class="small">Начален час</label>
            <input type="datetime-local" id="startAt" class="input" th:field="*{startAt}" required>
            <div class="text-danger small" th:errors="*{startAt}"></div>
          </div>

          <div>
            <label class="small">Реферален код (ако имате)</label>
            <input class="input" th:field="*{referredBy}">
          </div>

          <div style="grid-column:1 / -1;">
            <label class="small">Бележка</label>
            <textarea class="textarea" th:field="*{note}" rows="3" placeholder="По желание"></textarea>
          </div>
        </div>

        <div style="display:flex; gap:12px; margin-top:16px; justify-content:flex-end;">
          <a href="/services" class="btn btn-outline">Назад</a>
          <button class="btn" type="submit">Изпрати</button>
        </div>
      </form>
    </div>
  </div>

  <!-- JS (поправен шаблонен стринг с backticks) -->
  <script>
    const dateEl = document.getElementById('date');
    const slotsEl = document.getElementById('slots');
    const startAtEl = document.getElementById('startAt');

    if (dateEl) {
      dateEl.addEventListener('change', async () => {
        const d = dateEl.value;
        slotsEl.innerHTML = '';
        if (!d) return;

        try {
          const res = await fetch(`/api/availability?date=${d}&durationMinutes=60`);
          const data = await res.json();

          data.forEach(t => {
            const dt = new Date(t);
            const opt = document.createElement('option');
            const pad = (n)=> String(n).padStart(2,'0');
            opt.value = t;
            opt.textContent = pad(dt.getHours()) + ':' + pad(dt.getMinutes());
            slotsEl.appendChild(opt);
          });

          slotsEl.addEventListener('change', () => {
            const iso = slotsEl.value;
            if (!iso) return;
            const dt = new Date(iso);
            const pad = (n)=> String(n).padStart(2,'0');
            const local =
                    dt.getFullYear() + '-' + pad(dt.getMonth()+1) + '-' + pad(dt.getDate()) +
                    'T' + pad(dt.getHours()) + ':' + pad(dt.getMinutes());
            startAtEl.value = local;
          }, { once: true });
        } catch (e) {
          console.error(e);
        }
      });
    }
  </script>
</div>
</html>

