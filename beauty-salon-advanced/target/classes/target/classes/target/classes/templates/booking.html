<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout}">
<div th:fragment="content">

  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card shadow-lg border-0">
          <div class="card-header text-white text-center py-4" style="background: linear-gradient(135deg, #ff69b4, #ff1493);">
            <h2 class="mb-0"><i class="fas fa-calendar-check me-2"></i>–ó–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ —á–∞—Å</h2>
            <p class="mb-0 mt-2 text-white-75">–ü–æ–ø—ä–ª–Ω–∏ –¥–µ—Ç–∞–π–ª–∏—Ç–µ –∏ –∏–∑–±–µ—Ä–∏ —É–¥–æ–±–µ–Ω —á–∞—Å</p>
          </div>
          <div class="card-body p-4">
            <!-- Hero image -->
            <div class="text-center mb-4">
              <img src="/img/booking-appointment.png" alt="Nail District"
                   class="img-fluid rounded" style="max-height: 400px; object-fit: cover; width: 100%;">
            </div>

            <!-- –∏–∑–≤–µ—Å—Ç–∏—è -->
            <div class="alert alert-success alert-dismissible fade show" th:if="${ok}" role="alert">
              <i class="fas fa-check-circle me-2"></i>
              <strong>–£—Å–ø–µ—Ö!</strong> –£—Å–ø–µ—à–Ω–æ –∑–∞–ø–∞–∑–∏—Ö–º–µ —á–∞—Å–∞ –≤–∏. –©–µ –ø–æ–ª—É—á–∏—Ç–µ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ –ø–æ email.
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <div class="alert alert-danger alert-dismissible fade show" th:if="${error}" role="alert">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>–ì—Ä–µ—à–∫–∞!</strong> <span th:text="${error}"></span>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- —Ñ–æ—Ä–º–∞ -->
            <form method="post" th:action="@{/booking}" th:object="${appointment}">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label fw-semibold"><i class="fas fa-user me-1"></i>–ò–º–µ *</label>
                  <input type="text" class="form-control" th:field="*{customerName}" required 
                         placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –≤–∞—à–µ—Ç–æ –∏–º–µ">
                  <div class="text-danger small" th:errors="*{customerName}"></div>
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold"><i class="fas fa-envelope me-1"></i>–ò–º–µ–π–ª</label>
                  <input type="email" class="form-control" th:field="*{customerEmail}" 
                         placeholder="example@email.com">
                  <div class="text-danger small" th:errors="*{customerEmail}"></div>
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold"><i class="fas fa-phone me-1"></i>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                  <input type="tel" class="form-control" th:field="*{customerPhone}" id="phoneInput"
                         placeholder="+359 XXX XXX XXX" pattern="^[+0-9 ]{6,20}$">
                  <div class="text-danger small" th:errors="*{customerPhone}"></div>
                  <div class="invalid-feedback" id="phoneError">
                    –¢–µ–ª–µ—Ñ–æ–Ω–Ω–∏—è—Ç –Ω–æ–º–µ—Ä –Ω–µ –æ—Ç–≥–æ–≤–∞—Ä—è –Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∞. –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ —Å–∞–º–æ —Ü–∏—Ñ—Ä–∏, + –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏ (6-20 —Å–∏–º–≤–æ–ª–∞)
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold"><i class="fas fa-spa me-1"></i>–£—Å–ª—É–≥–∞ *</label>
                  <select class="form-select" th:field="*{service.id}" id="serviceSelect" required>
                    <option value="">–ò–∑–±–µ—Ä–µ—Ç–µ —É—Å–ª—É–≥–∞...</option>
                    <option th:each="s : ${services}" th:value="${s.id}" 
                            th:text="${s.name} + ' - ' + ${s.price} + '–ª–≤ (' + ${s.durationMinutes} + '–º–∏–Ω)'"
                            th:data-duration="${s.durationMinutes}"></option>
                  </select>
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold"><i class="fas fa-calendar me-1"></i>–î–∞—Ç–∞ *</label>
                  <input type="date" id="date" class="form-control" required>
                  <div class="form-text">–ò–∑–±–µ—Ä–µ—Ç–µ –¥–∞—Ç–∞, –∑–∞ –¥–∞ –≤–∏–¥–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω–∏—Ç–µ —á–∞—Å–æ–≤–µ</div>
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold"><i class="fas fa-clock me-1"></i>–°–≤–æ–±–æ–¥–Ω–∏ —á–∞—Å–æ–≤–µ</label>
                  <select id="slots" class="form-select" disabled>
                    <option>–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ –¥–∞—Ç–∞ –∏ —É—Å–ª—É–≥–∞...</option>
                  </select>
                  <div class="form-text">–†–∞–±–æ—Ç–Ω–æ –≤—Ä–µ–º–µ: 9:00 - 18:00</div>
                </div>

                <!-- Hidden field for actual datetime -->
                <input type="hidden" id="startAt" th:field="*{startAt}">
                <div class="text-danger small" th:errors="*{startAt}"></div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold"><i class="fas fa-gift me-1"></i>–†–µ—Ñ–µ—Ä–∞–ª–µ–Ω –∫–æ–¥</label>
                  <input type="text" class="form-control" th:field="*{referredBy}" 
                         placeholder="–ê–∫–æ —Å—Ç–µ –ø—Ä–µ–ø–æ—Ä—ä—á–∞–Ω–∏ –æ—Ç –ø—Ä–∏—è—Ç–µ–ª - ">
                  <div class="form-text">–ü–æ–ª—É—á–µ—Ç–µ 50% –æ—Ç—Å—Ç—ä–ø–∫–∞ –Ω–∞ —à–µ—Å—Ç–æ—Ç–æ –í–∏ –ø–æ—Å–µ—â–µ–Ω–∏–µ –≤ –Ω–∞—à–∏—è—Ç —Å–∞–ª–æ–Ω!</div>
                </div>

                <div class="col-12">
                  <label class="form-label fw-semibold"><i class="fas fa-comment me-1"></i>–ë–µ–ª–µ–∂–∫–∞</label>
                  <textarea class="form-control" th:field="*{note}" rows="3" 
                            placeholder="–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏–ª–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä–∏..."></textarea>
                </div>
              </div>

              <div class="d-flex gap-2 mt-4 justify-content-end">
                <a href="/services" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-1"></i>–ù–∞–∑–∞–¥</a>
                <button type="submit" class="btn btn-lg text-white" id="submitBtn" disabled style="background: linear-gradient(135deg, #ff69b4, #ff1493); border: none;">
                  <i class="fas fa-calendar-plus me-1"></i>–ó–∞–ø–∞–∑–∏ —á–∞—Å
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced JavaScript with Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const dateEl = document.getElementById('date');
    const serviceEl = document.getElementById('serviceSelect');
    const slotsEl = document.getElementById('slots');
    const startAtEl = document.getElementById('startAt');
    const submitBtn = document.getElementById('submitBtn');
    const phoneInput = document.getElementById('phoneInput');
    const phoneError = document.getElementById('phoneError');

    // Set minimum date to today
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    dateEl.min = tomorrow.toISOString().split('T')[0];
    
    // Set maximum date to 3 months from now
    const maxDate = new Date(today);
    maxDate.setMonth(maxDate.getMonth() + 3);
    dateEl.max = maxDate.toISOString().split('T')[0];

    function updateAvailability() {
      const date = dateEl.value;
      const serviceId = serviceEl.value;
      
      if (!date || !serviceId) {
        slotsEl.innerHTML = '<option>–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ –¥–∞—Ç–∞ –∏ —É—Å–ª—É–≥–∞...</option>';
        slotsEl.disabled = true;
        submitBtn.disabled = true;
        return;
      }

      // Get duration from selected service
      const selectedOption = serviceEl.options[serviceEl.selectedIndex];
      const duration = selectedOption.getAttribute('data-duration') || 60;
      
      // Show loading
      slotsEl.innerHTML = '<option><i class="fas fa-spinner fa-spin"></i> –ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</option>';
      slotsEl.disabled = true;

      fetch(`/api/availability?date=${date}&durationMinutes=${duration}`)
        .then(response => {
          console.log('API Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Available slots:', data);
          slotsEl.innerHTML = '';
          
          if (data.length === 0) {
            slotsEl.innerHTML = '<option>–ù—è–º–∞ —Å–≤–æ–±–æ–¥–Ω–∏ —á–∞—Å–æ–≤–µ –∑–∞ —Ç–∞–∑–∏ –¥–∞—Ç–∞</option>';
            submitBtn.disabled = true;
            return;
          }

          // Add default option
          const defaultOpt = document.createElement('option');
          defaultOpt.value = '';
          defaultOpt.textContent = '–ò–∑–±–µ—Ä–µ—Ç–µ —á–∞—Å...';
          slotsEl.appendChild(defaultOpt);

          // Add time slots
          data.forEach(timeSlot => {
            const dt = new Date(timeSlot);
            const opt = document.createElement('option');
            const pad = (n) => String(n).padStart(2, '0');
            opt.value = timeSlot;
            opt.textContent = pad(dt.getHours()) + ':' + pad(dt.getMinutes());
            slotsEl.appendChild(opt);
          });

          slotsEl.disabled = false;
        })
        .catch(error => {
          console.error('Error fetching availability:', error);
          slotsEl.innerHTML = `<option>–ì—Ä–µ—à–∫–∞: ${error.message}</option>`;
          slotsEl.disabled = false;
          submitBtn.disabled = true;
        });
    }

    function updateSubmitButton() {
      const hasDate = dateEl.value !== '';
      const hasService = serviceEl.value !== '';
      const hasSlot = slotsEl.value !== '';
      const hasName = document.querySelector('input[name="customerName"]').value.trim() !== '';
      
      submitBtn.disabled = !(hasDate && hasService && hasSlot && hasName);
    }

    // Event listeners
    dateEl.addEventListener('change', updateAvailability);
    serviceEl.addEventListener('change', updateAvailability);
    
    slotsEl.addEventListener('change', () => {
      const selectedSlot = slotsEl.value;
      if (selectedSlot) {
        startAtEl.value = selectedSlot;
        updateSubmitButton();
      }
    });

    // Phone validation
    phoneInput.addEventListener('input', function() {
      const phonePattern = /^[+0-9 ]{6,20}$/;
      if (this.value && !phonePattern.test(this.value)) {
        this.classList.add('is-invalid');
        this.classList.remove('is-valid');
      } else if (this.value) {
        this.classList.remove('is-invalid');
        this.classList.add('is-valid');
      } else {
        this.classList.remove('is-invalid', 'is-valid');
      }
      updateSubmitButton();
    });
    
    // Validate form inputs
    document.querySelector('input[name="customerName"]').addEventListener('input', updateSubmitButton);
    
    // Add visual feedback for required fields
    document.querySelectorAll('input[required], select[required]').forEach(field => {
      field.addEventListener('blur', function() {
        if (this.value.trim() === '') {
          this.classList.add('is-invalid');
        } else {
          this.classList.remove('is-invalid');
          this.classList.add('is-valid');
        }
      });
    });

    // Form submission validation
    document.querySelector('form').addEventListener('submit', function(e) {
      const requiredFields = this.querySelectorAll('input[required], select[required]');
      let isValid = true;
      let errorMessages = [];
      
      requiredFields.forEach(field => {
        if (field.value.trim() === '') {
          field.classList.add('is-invalid');
          isValid = false;
        }
      });
      
      if (!slotsEl.value) {
        slotsEl.classList.add('is-invalid');
        isValid = false;
        errorMessages.push('–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ —Å–≤–æ–±–æ–¥–µ–Ω —á–∞—Å');
      }
      
      // Validate phone format
      if (phoneInput.value) {
        const phonePattern = /^[+0-9 ]{6,20}$/;
        if (!phonePattern.test(phoneInput.value)) {
          phoneInput.classList.add('is-invalid');
          isValid = false;
          errorMessages.push('–ù–µ–≤–∞–ª–∏–¥–µ–Ω —Ñ–æ—Ä–º–∞—Ç –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω–∏—è –Ω–æ–º–µ—Ä');
        }
      }
      
      if (!isValid) {
        e.preventDefault();
        if (errorMessages.length > 0) {
          alert('–ì—Ä–µ—à–∫–∏:\n' + errorMessages.join('\n'));
        } else {
          alert('–ú–æ–ª—è, –ø–æ–ø—ä–ª–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏ –ø–æ–ª–µ—Ç–∞!');
        }
      }
    });
  </script>
  
  <!-- Discount Voucher Modal -->
  <div class="modal fade" id="discountVoucherModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
        <div class="modal-header text-white text-center border-0" style="background: linear-gradient(135deg, #ff69b4, #ff1493); border-radius: 20px 20px 0 0;">
          <h3 class="modal-title w-100 fw-bold">
            <i class="fas fa-gift me-2"></i>–ü–û–ó–î–†–ê–í–õ–ï–ù–ò–Ø! üéâ
          </h3>
        </div>
        <div class="modal-body p-5 text-center" th:if="${hasDiscount}">
          <div class="voucher-content">
            <div class="mb-4">
              <i class="fas fa-star" style="font-size: 4rem; color: #ffd700;"></i>
            </div>
            
            <h2 class="fw-bold mb-4" style="color: #ff1493;">
              –¢–æ–≤–∞ –µ –í–∞—à–µ—Ç–æ 6-—Ç–æ –ø–æ—Å–µ—â–µ–Ω–∏–µ!
            </h2>
            
            <div class="discount-details p-4 mb-4" style="background: linear-gradient(135deg, #fff5f8, #ffffff); border-radius: 15px; border: 3px dashed #ff69b4;">
              <h3 class="fw-bold mb-3" style="color: #ff1493;">
                50% –û–¢–°–¢–™–ü–ö–ê üéÅ
              </h3>
              
              <div class="row mb-3">
                <div class="col-6 text-end">
                  <strong>–î–∞—Ç–∞ –∏ —á–∞—Å:</strong>
                </div>
                <div class="col-6 text-start" th:text="${#temporals.format(discountedAppointment.startAt, 'dd.MM.yyyy HH:mm')}">
                  29.10.2025 11:00
                </div>
              </div>
              
              <div class="row mb-0">
                <div class="col-6 text-end">
                  <strong>–û—Ç—Å—Ç—ä–ø–∫–∞:</strong>
                </div>
                <div class="col-6 text-start" style="color: #ff1493; font-size: 1.5rem; font-weight: bold;">
                  50% OFF üéâ
                </div>
              </div>
            </div>
            
            <div class="alert alert-warning border-0 mb-4" style="background: #fff3cd; border-radius: 15px;">
              <i class="fas fa-mobile-alt me-2" style="color: #ff1493;"></i>
              <strong>–í–ê–ñ–ù–û:</strong> –ü—Ä–∏ –í–∞—à–µ—Ç–æ –ø–æ—Å–µ—â–µ–Ω–∏–µ –≤ —Å–∞–ª–æ–Ω–∞, –ø–æ–∫–∞–∂–µ—Ç–µ screenshot –æ—Ç —Ç–∞–∑–∏ —Ñ–æ—Ä–º–∞!
            </div>
            
            <p class="text-muted mb-4">
              <i class="fas fa-envelope me-2"></i>
              –ü–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–æ –Ω–∞ –í–∞—à–∏—è –µ–º–µ–π–ª
            </p>
          </div>
        </div>
        <div class="modal-footer border-0 justify-content-center">
          <button type="button" class="btn btn-lg px-5 text-white" style="background: linear-gradient(135deg, #ff69b4, #ff1493);" data-bs-dismiss="modal">
            <i class="fas fa-check me-2"></i>–†–∞–∑–±—Ä–∞—Ö!
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Auto-show discount modal if discount was applied -->
  <script th:if="${hasDiscount}">
    document.addEventListener('DOMContentLoaded', function() {
      // Scroll to top first
      window.scrollTo(0, 0);
      
      // Show the discount modal
      setTimeout(function() {
        var discountModal = new bootstrap.Modal(document.getElementById('discountVoucherModal'), {
          backdrop: 'static',
          keyboard: false
        });
        discountModal.show();
      }, 500);
    });
  </script>
</div>
</html>

